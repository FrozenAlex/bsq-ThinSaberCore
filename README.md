# ThinSaberLite

A version agnostic[^1] Beat Saber mod that can make your saber's thinner.

[^1]: Version Agnostic: Will work on (theoretically) any Beat Saber version, even without core mods!

### Disclaimers
1. **The mod will not work if ThinSabers or ShortSaber is installed, due to conflicts.**
2. **The mod will not work if TrickSaber is installed, and `tricksaberSafeMode` is set to `true`.**
3. **The mod does not rely on any core mods to function, so there is no UI menu to edit the config. To learn about editing the config, see [Editing the Config](#editing-the-config).**

## How to Use
### Installation
1. Download the `.qmod` file from the releases page or from the [Beat Saber Modding Group](https://discord.gg/beatsabermods).
2. Install the downloaded file using [BMBF](https://bmbf.dev/). (Available in SideQuest also.)
3. Press the `Sync To BeatSaber` button.
4. Done!

### Editing the Config
ThinSaberLite does not have any form of UI. It does still have a config however!
1. Download `thinsaberlite.json` from the [releases]() page or from the [Beat Saber Modding Group](https://discord.gg/beatsabermods).
2. Open the downloaded JSON file in your favourite text editor.
3. Edit the values to your liking.
4. Save the file.
5. Select or Drag & Drop the file in [BMBF](https://bmbf.dev/).
6. Press the `Sync To BeatSaber` button.
7. Done!

## Config Values
There are two (2) editable values in the config:
- `thickness`
- `tricksaberSafeMode`

### Thickness
#### Type: Float/Real
I think this goes without saying that this is the value you edit to change the thickness. <br>
It can be any value between 0 and 1 inclusive. 1 being normal size. <br>
If you try to make this value greater than 1 or less than 0, it will default back to a thickness of 1.

### TrickSaberSafeMode
#### Type: Boolean
If this is `true`, and TrickSaber is installed, the mod will not work. <br>
This is to prevent a bug where, if the saber is thrown, the saber thrown will get thinner and longer. <br>
If you want to disable this, set the value to `false`

## How does it work?
To understand how ThinSaberLite remains version agnostic, we first need to understand how `Codegen` works, and what the C++ linker does.
### Codegen
Codegen, in essence, is a wrapper around an "essential" library called `beatsaber-hooks`. In order for this mod to work, we need to set the `localScale` of the sabers. Normally, we could use Codegen to do this; Codegen provides wrapper types that mimic the C# types that the game uses. The code for this mod using Codegen would look something like this:
```cpp
MAKE_HOOK_MATCH(SaberModelController_Init, &GlobalNamespace::SaberController::Init, void, GlobalNamespace::SaberController *self,
                                     UnityEngine::Transform *parent,
                                     GlobalNamespace::Saber *saber
                                     ) {
    SaberModelController_Init(self, parent, saber);

    auto *transform = self->get_transform();
    auto *basicSaberTransform =  transfrom->Find("BasicSaber");
    basicSaberTransfrom.localScale = saberScale; // Saber scale is defined and set outside the hook
}
```
This is very easy to do, but maintainign such a small mod is not really worthwhile. So to make it more worthwhile, we can make it version agnostic. A version agnostic mod cannot rely on Codegen or any other libraries that also depend on Codegen, such as BSML or QuestUI (this means we cannot have UI either). The reason for this is due to how Codegen works and what the C++ linker does.

### C++ Linker
This has been grossly over simplified. The last stage when compiling a C++ project is linking. If a mod uses a library, the mod will need to be "linked" to that library. Essentially, we need to tell C++ to use the library's code when using the library's methods. This is what the linker does. The linker resolves the symbols of methods used in the mod's code, and associates them with the library. When the game updates, Codegen needs to be regenerated. This can sometimes mean that the symbols of functions change, leading to some mods not working, depending on the changes. Thus, when we try to use codegen methods in a mod compiled with an earlier version of Codegen, it breaks. The solution, is to remove Codegen from the equation.

### Modding Without Codegen
Codegen, at the most basic level, wraps `beatsaber-hooks` to invoke methods, get/set fiels...etc. Here is an example of what a codegen method looks like:
```cpp
// Autogenerated method: ConnectedPlayerManager/ConnectedPlayer.UpdateSortIndex
bool GlobalNamespace::ConnectedPlayerManager::ConnectedPlayer::UpdateSortIndex(int index) {
  static auto ___internal__logger = ::Logger::get().WithContext("::GlobalNamespace::ConnectedPlayerManager::ConnectedPlayer::UpdateSortIndex");
  static auto* ___internal__method = THROW_UNLESS((::il2cpp_utils::FindMethod(this, "UpdateSortIndex", std::vector<Il2CppClass*>{}, ::std::vector<const Il2CppType*>{::il2cpp_utils::ExtractType(index)})));
  return ::il2cpp_utils::RunMethodRethrow<bool, false>(this, ___internal__method, index);
}
``` 
We can do what we want to do using a similar method. Without Codegen, we need to resolve the method we need to hook manually, in addition to getting the functions/properties ourselves. Doing this, this is what the mod's code looks like now:
```cpp
MAKE_HOOK_FIND_CLASS_UNSAFE_INSTANCE(SaberModelController_Init, "", "SaberModelController", "Init", void, Il2CppObject *self,
                                     Il2CppObject *parent, // UnityEngine.Transform
                                     Il2CppObject *saber // global::Saber
                                     ) {
    SaberModelController_Init(self, parent, saber);

    Il2CppObject *transform = CRASH_UNLESS(il2cpp_utils::GetPropertyValue(self, "transform")); // get the UnityEngine.Transform of host GameObject
    static auto *findMethodInfo = CRASH_UNLESS(il2cpp_utils::FindMethodUnsafe(transform, "Find", 1)); // get method info for Transform.Find(String) - returns UnityEngine.Transform
    Il2CppObject *basicSaberTransform = CRASH_UNLESS(il2cpp_utils::RunMethodUnsafe(transform, findMethodInfo, il2cpp_utils::newcsstr("BasicSaber"))); // Invoke Transform.Find for "BasicSaber"
    CRASH_UNLESS(il2cpp_utils::SetPropertyValue(basicSaberTransform, "localScale", saberScale)); // Set the localScale of BasicSaber's Transform
}
```
And that's how this mod is version agnostic. It is harder than using Codegen, which is why it isn't more widely used for modding.

## Credits

* [zoller27osu](https://github.com/zoller27osu), [Sc2ad](https://github.com/Sc2ad) and [jakibaki](https://github.com/jakibaki) - [beatsaber-hook](https://github.com/sc2ad/beatsaber-hook)
* [raftario](https://github.com/raftario)
* [Lauriethefish](https://github.com/Lauriethefish), [danrouse](https://github.com/danrouse) and [Bobby Shmurner](https://github.com/BobbyShmurner) for [this template](https://github.com/Lauriethefish/quest-mod-template)
